## HLAVN√ç BODY DNE

* [Zde budou strategick√© zmƒõny v kalend√°≈ôi]
* [D≈Øle≈æit√© sch≈Øzky]

--------------------

const { createClient } = require('@supabase/supabase-js');
const { google } = require('googleapis');
const { GoogleGenerativeAI } = require('@google/generative-ai');
require('dotenv').config({ path: '.env.local' });

const supabase = createClient(process.env.SUPABASE_URL, process.env.SUPABASE_SERVICE_KEY || process.env.SUPABASE_KEY);
const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);

// --- 1. Fetch Data ---
async function getDailyData(userId) {
  const todayStart = new Date();
  todayStart.setHours(0, 0, 0, 0);
  const todayEnd = new Date();
  todayEnd.setHours(23, 59, 59, 999);

  const { data: todos } = await supabase
    .from('todos')
    .select('*')
    .eq('user_id', userId)
    .in('status', ['pending', 'in_progress'])
    .lte('due_date', todayEnd.toISOString().split('T')[0]);

  const { data: events } = await supabase
    .from('events')
    .select('*')
    .eq('user_id', userId)
    .gte('start_time', todayStart.toISOString())
    .lte('start_time', todayEnd.toISOString());

  const yesterday = new Date();
  yesterday.setDate(yesterday.getDate() - 1);
  
  const { data: updates } = await supabase
    .from('cp_states')
    .select('state, summary_text, last_updated, cps(name, primary_identifier)')
    .gt('last_updated', yesterday.toISOString());

  const myUpdates = updates ? updates.filter(u => u.cps && u.cps.user_id === userId) : [];

  return { todos: todos || [], events: events || [], updates: myUpdates };
}

// --- 2. Generate Content (HTML) ---
async function generateBrief(data, clientName) {
  const model = genAI.getGenerativeModel({ model: 'gemini-2.5-flash-lite' });

  // FIXED: Removed brackets from list items
  const todoList = data.todos.map(t => `<li><strong>√öKOL:</strong> ${t.description} (Term√≠n: ${t.due_date})</li>`).join('');
  const eventList = data.events.map(e => `<li><strong>UD√ÅLOST:</strong> ${e.location} @ ${e.start_time}</li>`).join('');
  const updateList = data.updates.map(u => `<li><strong>${u.cps.name}</strong> (${u.state}): ${u.summary_text}</li>`).join('');

  const prompt = `
    Role: Executive Assistant.
    Task: Write the body of a daily briefing email for ${clientName}.
    Language: Czech (cs-CZ).
    Format: HTML (use <p>, <ul>, <li>, <strong>). Do NOT include <html> or <body> tags.
    Style: Professional, concise, larger font friendly.

    Input Data:
    Tasks: ${todoList ? '<ul>' + todoList + '</ul>' : '≈Ω√°dn√© √∫koly.'}
    Activity: ${updateList ? '<ul>' + updateList + '</ul>' : '≈Ω√°dn√© aktualizace.'}

    Structure:
    1. Greeting (Dobr√Ω den...)
    2. Sections for √ökoly, Ud√°losti, and Aktivity.
    3. Closing sentence (encouraging).
    Do NOT add a signature.
  `;

  try {
    const result = await model.generateContent(prompt);
    let text = result.response.text();
    text = text.replace(/```html/g, '').replace(/```/g, '');
    return text;
  } catch (err) {
    console.error('GenAI Error:', err.message);
    return `<p>Error generating brief: ${err.message}</p>`;
  }
}

// --- 3. Send Email ---
async function sendEmailToSelf(gmail, email, subject, bodyHtml) {
  const utf8Subject = Buffer.from(subject).toString('base64');
  const encodedSubject = `=?UTF-8?B?${utf8Subject}?=`;

  const fullHtml = `
    <div style="font-family: Arial, sans-serif; font-size: 16px; line-height: 1.6; color: #333;">
      ${bodyHtml}
      <br><br>
      <div style="font-size: 16px; font-weight: bold; color: #555;">
        S pozdravem,<br>



V√°≈° V√Ωkonn√Ω Asistent Special Agent 23

--------------------


      </div>
    </div>
  `;
  
  const messageParts = [
    'Content-Type: text/html; charset=utf-8',
    'MIME-Version: 1.0',
    'To: ' + email,
    `Subject: ${encodedSubject}`,
    'Importance: High',
    'X-Priority: 1',
    '',
    fullHtml
  ].join('\n');
  
  const encodedMessage = Buffer.from(messageParts)
    .toString('base64')
    .replace(/\+/g, '-')
    .replace(/\//g, '_')
    .replace(/=+$/, '');
  
  await gmail.users.messages.send({
    userId: 'me',
    requestBody: {
      raw: encodedMessage,
      labelIds: ["STARRED", "IMPORTANT", "INBOX"] 
    }
  });
}

// --- Main ---
async function main() {
  console.log('--- üåÖ Starting Daily Brief Generation ---');
  
  const { data: clients, error } = await supabase.from('users').select('*');
  if (error) { console.error('DB Error:', error); return; }

  for (const client of clients) {
    if (!client.google_oauth_tokens) continue;

    console.log(`Preparing brief for: ${client.email}`);
    
    try {
      const dbData = await getDailyData(client.id);
      const briefBody = await generateBrief(dbData, client.settings.name || 'Client');
      
      // FIXED: Mixed Language Subject Line
      const subject = 'Denn√≠ P≈ôehled od va≈°eho 

--------------------

';
      
      const tokens = typeof client.google_oauth_tokens === 'string' 
        ? JSON.parse(client.google_oauth_tokens) 
        : client.google_oauth_tokens;
        
      const oauth2Client = new google.auth.OAuth2(
        process.env.GOOGLE_CLIENT_ID,
        process.env.GOOGLE_CLIENT_SECRET,
        process.env.GOOGLE_REDIRECT_URI
      );
      oauth2Client.setCredentials(tokens);
      const gmail = google.gmail({ version: 'v1', auth: oauth2Client });

      await sendEmailToSelf(gmail, client.email, subject, briefBody);
      console.log(`‚úì Sent to ${client.email}`);

    } catch (err) {
      console.error(`Error for ${client.email}:`, err.message);
    }
  }
  console.log('--- Done ---');
}

main();
